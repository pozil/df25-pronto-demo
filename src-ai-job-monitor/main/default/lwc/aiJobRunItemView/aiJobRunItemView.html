<template>
  <!-- Job Run Details -->
  <template lwc:if={jobRun}>
    <div class="slds-var-m-bottom_large">
      <div class="slds-box slds-theme_shade slds-var-p-around_medium">
        <h2 class="slds-text-heading_medium slds-var-m-bottom_small">Job Details</h2>
        <div class="slds-grid slds-wrap slds-gutters">
          <!-- Name -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Name">Name:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.Name}</dd>
            </dl>
          </div>

          <!-- Label -->
          <div lwc:if={jobRun.Label} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Label">Label:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.Label}</dd>
            </dl>
          </div>

          <!-- Job Type -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Job Type">Job Type:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.JobType}</dd>
            </dl>
          </div>

          <!-- Target -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Target">Target:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.Target}</dd>
            </dl>
          </div>

          <!-- Status -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Status">Status:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.Status}</dd>
            </dl>
          </div>

          <!-- Created Date -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Created Date">Created Date:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.CreatedDate}</dd>
            </dl>
          </div>

          <!-- Created By -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Created By">Created By:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.CreatedBy}</dd>
            </dl>
          </div>

          <!-- Start Time -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Start Time">Start Time:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.StartTime}</dd>
            </dl>
          </div>

          <!-- End Time -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="End Time">End Time:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.EndTime}</dd>
            </dl>
          </div>

          <!-- Duration -->
          <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Duration">Duration:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.Duration}</dd>
            </dl>
          </div>

          <!-- Error Code -->
          <div
            lwc:if={jobRun.ErrorCode}
            class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3"
          >
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Error Code">Error Code:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.ErrorCode}</dd>
            </dl>
          </div>

          <!-- Error Message -->
          <div lwc:if={jobRun.ErrorMessage} class="slds-col slds-size_1-of-1">
            <dl class="slds-list_horizontal slds-wrap">
              <dt class="slds-item_label slds-text-color_weak slds-truncate" title="Error Message">Error Message:</dt>
              <dd class="slds-item_detail slds-truncate">{jobRun.ErrorMessage}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template lwc:if={isLoading}>
    <div class="slds-is-relative">
      <lightning-spinner alternative-text="Loading AI Job Run Items..." size="medium"></lightning-spinner>
    </div>
  </template>
  <template lwc:else>
    <template lwc:if={hasData}>
      <!-- Status Summary -->
      <template lwc:if={hasStatusCounts}>
        <div class="slds-var-m-bottom_medium">
          <div class="slds-box slds-theme_shade slds-var-p-around_small">
            <h3 class="slds-text-heading_medium slds-var-m-bottom_small">Job Item Statuses</h3>
            <div class="slds-grid slds-wrap slds-gutters_small">
              <template for:each={statusSummary} for:item="statusItem">
                <div
                  key={statusItem.status}
                  class="slds-col slds-size_1-of-1 slds-small-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-4"
                >
                  <div class="slds-box slds-box_x-small slds-text-align_center">
                    <div class="slds-text-heading_medium slds-text-color_success">{statusItem.count}</div>
                    <div class="slds-text-body_small slds-text-color_weak">{statusItem.status}</div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </template>

      <lightning-datatable
        key-field="Id"
        data={aiJobRunItems}
        columns={columns}
        hide-checkbox-column="true"
        default-sort-direction="desc"
        sorted-direction="desc"
        sorted-by="CreatedDate"
      >
      </lightning-datatable>

      <!-- Pagination Controls -->
      <div class="slds-var-p-top_medium slds-var-p-bottom_medium">
        <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
          <!-- Page Size Selector -->
          <div class="slds-grid slds-grid_vertical-align-center slds-var-m-right_medium">
            <label class="slds-form-element__label slds-var-m-right_x-small">Show:</label>
            <div class="slds-form-element__control">
              <select class="slds-select" onchange={handlePageSizeChange}>
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>

          <!-- Page Info -->
          <div class="slds-text-body_small slds-text-color_weak">{currentPageInfo}</div>

          <!-- Pagination Buttons -->
          <lightning-button-group>
            <lightning-button
              variant="neutral"
              onclick={handleFirstPage}
              disabled={isFirstPage}
              title="First Page"
              icon-name="utility:jump_to_left"
              icon-size="x-small"
            ></lightning-button>
            <lightning-button
              variant="neutral"
              onclick={handlePreviousPage}
              disabled={isFirstPage}
              title="Previous Page"
              icon-name="utility:chevronleft"
              icon-size="x-small"
            ></lightning-button>
            <lightning-button
              variant="neutral"
              onclick={handleNextPage}
              disabled={isLastPage}
              title="Next Page"
              icon-name="utility:chevronright"
              icon-size="x-small"
            ></lightning-button>
            <lightning-button
              variant="neutral"
              onclick={handleLastPage}
              disabled={isLastPage}
              title="Last Page"
              icon-name="utility:jump_to_right"
              icon-size="x-small"
            ></lightning-button>
          </lightning-button-group>
        </div>
      </div>
    </template>
    <template lwc:else>
      <div class="slds-var-p-vertical_large slds-var-p-horizontal_medium slds-text-align_center">
        <lightning-icon icon-name="standard:ai" size="large" variant="inverse"></lightning-icon>
        <h3 class="slds-text-heading_medium slds-var-m-top_small">No AI Job Run Items Found</h3>
        <p class="slds-text-body_regular slds-var-m-top_x-small">
          There are currently no AI Job Run Items to display for this job run.
        </p>
      </div>
    </template>
  </template>

  <template lwc:if={hasError}>
    <div
      class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error slds-var-m-bottom_small"
      role="alert"
    >
      <span class="slds-assistive-text">Error</span>
      <span
        class="slds-icon_container slds-icon-utility-error slds-var-m-right_x-small"
        title="Description of icon when needed"
      >
        <lightning-icon icon-name="utility:error" size="x-small"></lightning-icon>
      </span>
      <h2>Error loading AI Job Run Items</h2>
      <p>{errorMessage}</p>
    </div>
  </template>
</template>
